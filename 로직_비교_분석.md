# 현재 로직 vs 요구사항 비교 분석

## 규칙 1: 문장 A와 70% 일치하는 짧은 문장 A'이 있으면 A'를 제거한다.

### 현재 로직 분석
```python
# 180-181줄: 현재 문장이 저장된 문장을 포함하거나 80% 유사하면
if current_sentence in stored_sentence or \
   text_processor.calculate_similarity(current_sentence, stored_sentence, "min"):
    # 저장된 문장 제거
```

```python
# 198줄: 저장된 문장이 현재 문장을 포함하면
elif stored_sentence in current_sentence:
    # 현재 문장 제거
```

```python
# 204-206줄: 70% 유사하면
elif current_sentence == stored_sentence or \
     text_processor.calculate_similarity(current_sentence, stored_sentence, "max"):
    if len(current_normalized_sentences) <= len(stored_normalized_sentences):
        # 현재 문장 제거
```

### 문제점
1. ❌ **개별 문장의 길이 비교 없음**: 현재는 집합의 문장 개수만 비교하고, 개별 문장 A와 A'의 길이를 비교하지 않음
2. ❌ **70% 유사도 기준 불명확**: "max" 기준은 70%이지만, "짧은 문장" 조건이 없어서 긴 문장도 제거될 수 있음
3. ⚠️ **우선순위 문제**: 포함 관계(`in`) 체크가 유사도 체크보다 먼저 실행되어, 짧은 문장이 긴 문장에 포함되면 바로 제거됨 (이 부분은 규칙과 일치할 수 있음)

### 개선 필요사항
- 개별 문장의 단어 수 또는 문자 수를 비교하여 "짧은 문장"을 판단해야 함
- 70% 유사도 + 짧은 문장 조건을 함께 만족할 때만 제거하도록 수정

---

## 규칙 2: A, B, C 문장 집합과 B, C, D, E 문장 집합이 있으면 A, B, C 쪽에서 A, B를 제거한다.

### 현재 로직 분석
```python
# 56-97줄: _check_subset_relationship 함수
# 현재 집합이 저장된 집합의 부분집합인지 확인
if current_subset_count == len(current_normalized) and len(current_normalized) < len(stored_normalized):
    return True, 'current'  # 현재 집합 전체 제거
```

### 문제점
1. ❌ **부분집합 전체 제거**: 규칙 2는 부분집합 전체를 제거하는 것이 아니라, **교집합(B, C)을 제외한 나머지(A)만 제거**해야 함
2. ❌ **교집합 보존 로직 없음**: 현재는 A ⊂ B 관계일 때 A 전체를 제거하지만, 규칙 2는 A, B, C에서 A만 제거하고 B, C는 유지해야 함
3. ❌ **교집합 요소 식별 로직 없음**: 어떤 문장이 교집합에 속하는지 식별하는 로직이 없음

### 개선 필요사항
- 두 집합의 교집합을 찾는 로직 추가
- 교집합을 제외한 나머지 문장만 제거하도록 수정
- 예: A, B, C와 B, C, D, E 비교 → A, B, C에서 A만 제거 → 결과: B, C

---

## 규칙 3: A, B, C 문장 집합과 A', B, C가 있으면 A', B, C를 제거한다.

### 현재 로직 분석
```python
# 140-148줄: _are_identical_quote_sets 함수
# 두 집합이 동일하면 현재 항목 제거
if self._are_identical_quote_sets(...):
    current_quote_sentences = []  # 현재 항목 전체 제거
```

```python
# 204-210줄: 개별 문장 단위 비교
elif current_sentence == stored_sentence or \
     text_processor.calculate_similarity(current_sentence, stored_sentence, "max"):
    if len(current_normalized_sentences) <= len(stored_normalized_sentences):
        del current_quote_sentences[current_sentence_index]  # 현재 문장만 제거
```

### 문제점
1. ❌ **규칙 3 미구현**: A'와 A가 유사하지만 완전히 동일하지 않은 경우, A', B, C 전체를 제거해야 하는데 현재는 개별 문장 단위로만 처리
2. ⚠️ **부분 일치 처리 불명확**: A'와 A가 70% 유사하고, B, C는 동일한 경우, A', B, C 전체를 제거해야 하지만 현재는 A'만 제거될 수 있음
3. ❌ **집합 단위 비교 부족**: 개별 문장 비교는 하지만, "대부분의 문장이 일치하고 하나만 유사한 경우" 전체 집합을 제거하는 로직이 없음

### 개선 필요사항
- 두 집합을 비교하여:
  - 하나의 문장만 유사하고(A' vs A)
  - 나머지 문장들이 모두 동일하면(B, C = B, C)
  - 유사한 문장이 포함된 집합 전체를 제거하는 로직 추가

---

## 종합 비교표

| 규칙 | 요구사항 | 현재 로직 | 일치 여부 | 문제점 |
|------|----------|-----------|-----------|--------|
| 규칙 1 | 70% 일치하는 **짧은** 문장 A' 제거 | 70% 유사도 체크는 있으나 **길이 비교 없음** | ❌ 부분 일치 | 개별 문장 길이 비교 로직 필요 |
| 규칙 2 | 교집합 제외한 나머지만 제거 (A, B, C → B, C) | 부분집합 전체 제거 (A, B, C → 제거) | ❌ 불일치 | 교집합 보존 로직 필요 |
| 규칙 3 | 유사 문장 포함 집합 전체 제거 (A', B, C → 제거) | 개별 문장만 제거 가능 (A'만 제거) | ❌ 불일치 | 집합 단위 비교 로직 필요 |

---

## 개선 방향

1. **규칙 1 개선**: 개별 문장의 길이(단어 수)를 비교하여 짧은 문장만 제거
2. **규칙 2 개선**: 교집합을 찾아서 교집합은 보존하고 나머지만 제거
3. **규칙 3 개선**: 집합 단위 비교로 대부분 일치하고 하나만 유사한 경우 전체 집합 제거

