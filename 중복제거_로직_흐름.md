# 중복 제거 로직 상세 흐름

## 전체 구조

### 메인 함수: `remove_duplicates()`

**입력**: `data` (발언 데이터 리스트), `progress_tracker` (진행률 추적기)
**출력**: 중복 제거된 데이터 리스트

---

## 1단계: 초기화

```python
# 289-303줄
```

1. 데이터 유효성 검사
   - `data`가 비어있으면 빈 리스트 반환

2. 텍스트 처리기 초기화
   - `TextProcessor` 인스턴스 생성

3. 캐시 및 결과 저장소 초기화
   - `quote_sentence_cache`: 정규화된 문장 캐시 (비교용)
   - `deduplicated_entries`: 중복 제거된 최종 데이터

4. 진행률 추적 초기화
   - 진행률 바 설정 및 tqdm 초기화

---

## 2단계: 각 항목 처리 (메인 루프)

```python
# 306-478줄: for entry_index, current_entry in enumerate(data)
```

### 2.1 현재 항목 전처리

```python
# 307-308줄
```

1. **큰따옴표 문장 분리**
   - `current_entry["큰따옴표 발언"]`을 `"  "` (공백 2개)로 분리
   - 결과: `current_quote_sentences` (원본 문장 리스트)

2. **문장 정규화**
   - 각 문장을 `text_processor.normalize_text()`로 정규화
   - 결과: `current_normalized_sentences` (정규화된 문장 리스트)

---

### 2.2 저장된 항목들과 비교 (중첩 루프)

```python
# 310-464줄: while comparison_index < len(quote_sentence_cache)
```

**비교 대상**: 이미 처리된 모든 항목 (`deduplicated_entries`)

각 저장된 항목에 대해 다음 순서로 처리:

---

#### **우선순위 1: 완전 동일한 집합 체크**

```python
# 316-325줄
```

**함수**: `_are_identical_quote_sets()`

**로직**:
1. 문장 개수 비교
   - `len(current_quotes) != len(stored_quotes)` → False 반환
2. 일대일 완전 일치 확인
   - 각 `current_norm`에 대해 완전히 동일한 `stored_norm` 찾기
   - `current_norm == stored_norm` (정규화된 문자열 완전 일치)
3. 모든 문장이 일대일로 매칭되면 → **현재 항목 전체 제거** (`break`)

**결과**: 완전히 동일하면 현재 항목 제거하고 다음 항목으로

---

#### **우선순위 2: 규칙 3 적용**

```python
# 327-352줄
```

**함수**: `_apply_rule3_similar_set_removal()`

**조건**: 
- 두 집합의 문장 개수가 동일
- 대부분의 문장이 70% 유사 (완전 일치도 포함)
- 매칭되지 않은 문장이 각각 1개씩
- 그 두 문장 중 하나가 다른 하나에 완전히 포함되고, 길이가 50% 이하

**로직**:
1. **70% 유사도로 일대일 매칭**
   ```python
   # 202-215줄
   ```
   - 각 `current_norm`에 대해 70% 유사한 `stored_norm` 찾기
   - 완전 일치 (`==`) 또는 `calculate_similarity(..., "max")` (70% 이상)
   - 매칭된 쌍: `matched_pairs`
   - 매칭되지 않은 문장: `unmatched_current`, `unmatched_stored`

2. **규칙 3 조건 확인**
   ```python
   # 227-248줄
   ```
   - `len(matched_pairs) >= len(current_normalized) - 1`
   - `len(unmatched_current) == 1` and `len(unmatched_stored) == 1`
   - 두 매칭되지 않은 문장의 포함 관계 및 길이 확인:
     - `unmatched_current_norm in unmatched_stored_norm` 또는
     - `unmatched_stored_norm in unmatched_current_norm`
     - 포함된 문장의 길이가 포함하는 문장의 50% 이하

3. **제거 대상 결정**
   - 짧은 문장(A')이 포함된 집합(A', B, C) 전체 제거

**결과**: 
- `rule3_to_remove == 'current'` → 현재 항목 전체 제거 (`break`)
- `rule3_to_remove == 'stored'` → 저장된 항목 제거 후 계속 비교 (`continue`)

---

#### **우선순위 3: 규칙 2 적용**

```python
# 354-395줄
```

**함수**: `_apply_rule2_intersection_removal_from_smaller()`

**목적**: 교집합을 개수가 더 작은 문장 집합에서 제거
- 예: A, B, C (3개)와 B, C, D, E (4개) → A, B, C에서 B, C 제거 → 결과: A

**로직**:
1. **교집합 찾기**
   ```python
   # 106-116줄: _find_intersection_sentences()
   ```
   - 각 `current_norm`에 대해 `stored_norm`과 비교:
     - 완전 일치 (`==`)
     - 포함 관계 (`in`)
     - 유사도 70% 이상 (`calculate_similarity(..., "max")`)
   - 결과: `intersection_pairs` (current_index, stored_index) 튜플 집합

2. **두 집합의 크기 비교**
   ```python
   # 143-145줄
   ```
   - 현재 집합과 저장된 집합의 문장 개수 비교

3. **작은 집합에서 교집합 제거**
   ```python
   # 147-171줄
   ```
   - 작은 집합에서 교집합 인덱스를 제외한 문장만 남김
   - 교집합이 제거되었는지 확인

**결과**:
- `rule2_target == 'current'`:
  - `updated_quotes`가 비어있으면 → 현재 항목 제거 (`break`)
  - 남아있으면 → 교집합 제거된 상태로 업데이트 후 계속 비교
- `rule2_target == 'stored'`:
  - `updated_quotes`가 비어있으면 → 저장된 항목 제거 후 계속 비교 (`continue`)
  - 남아있으면 → 교집합 제거된 상태로 업데이트 후 계속 비교

---

#### **우선순위 4: 규칙 1 적용 (개별 문장 단위)**

```python
# 378-464줄
```

**함수**: `_check_rule1_short_sentence_duplicate()`

**목적**: 70% 일치하는 짧은 문장 제거

**이중 루프 구조**:
```python
# 380-463줄
while current_sentence_index < len(current_normalized_sentences):
    while stored_sentence_index < len(stored_normalized_sentences):
        # 각 문장 쌍 비교
```

**각 문장 쌍에 대해 다음 순서로 처리**:

##### **4-1. 규칙 1 적용**

```python
# 387-413줄
```

**함수**: `_check_rule1_short_sentence_duplicate()`

**로직**:
1. **포함 관계 먼저 체크**
   ```python
   # 60-75줄
   ```
   - `current_sentence in stored_sentence` 또는
   - `stored_sentence in current_sentence`
   - 포함 관계가 있으면:
     - **작은 쪽을 기준으로 유사도 계산** (100% 유사도로 간주)
     - 짧은 문장 제거

2. **포함 관계가 없으면 일반 유사도 체크**
   ```python
   # 77-87줄
   ```
   - `calculate_similarity(..., "max")` (70% 임계값)
   - 유사도가 70% 이상이면 → 짧은 문장 제거

**결과**:
- `rule1_to_remove == 'current'` → 현재 문장 제거, 다음 문장으로
- `rule1_to_remove == 'stored'` → 저장된 문장 제거, 저장된 항목 업데이트

##### **4-2. 완전 포함 관계 체크 (하위 호환성)**

```python
# 415-436줄
```

- `current_sentence in stored_sentence` → 저장된 문장 제거
- `stored_sentence in current_sentence` → 현재 문장 제거

##### **4-3. 완전 일치 체크**

```python
# 438-459줄
```

- `current_sentence == stored_sentence`
- 문장 개수가 적은 쪽의 문장 제거
- 같으면 현재 문장 제거

---

### 2.3 최종 처리

```python
# 466-472줄
```

**조건**: `if current_quote_sentences:`

1. **남은 문장이 있으면**
   - `current_entry["큰따옴표 발언"]` 업데이트
   - `deduplicated_entries`에 추가
   - `quote_sentence_cache`에 정규화된 문장 캐시 추가

2. **남은 문장이 없으면**
   - 현재 항목은 제거됨 (추가하지 않음)

---

## 3단계: 진행률 업데이트 및 종료

```python
# 474-485줄
```

1. **진행률 업데이트**
   - `progress_tracker.update_progress()` 호출

2. **예외 처리**
   - 오류 발생 시 에러 메시지 출력 및 traceback

3. **최종 정리**
   - `progress_tracker.close_tqdm()` 호출
   - `deduplicated_entries` 반환

---

## 규칙별 상세 로직

### 규칙 1: 70% 일치하는 짧은 문장 제거

**함수**: `_check_rule1_short_sentence_duplicate()`

**처리 순서**:
1. 포함 관계 체크 (`in` 연산자)
   - 포함 관계가 있으면 → 작은 쪽 기준으로 100% 유사도로 간주
   - 짧은 문장 제거
2. 포함 관계가 없으면
   - `calculate_similarity(..., "max")` (70% 임계값)
   - 70% 이상이면 → 짧은 문장 제거

**유사도 계산 기준**:
- 포함 관계: 작은 쪽 기준 (100%)
- 일반 유사도: 큰 쪽 기준 (70% 임계값)

---

### 규칙 2: 교집합을 개수가 더 작은 문장 집합에서 제거

**함수**: `_apply_rule2_intersection_removal_from_smaller()`

**처리 순서**:
1. 교집합 찾기 (`_find_intersection_sentences()`)
   - 완전 일치, 포함 관계, 또는 70% 유사도로 매칭
2. 두 집합의 크기 비교
   - 현재 집합과 저장된 집합의 문장 개수 비교
3. 작은 집합에서 교집합 제거
   - 작은 집합에서 교집합 인덱스를 제외한 문장만 남김
4. 결과 반환
   - 수정된 집합 반환

**예시**:
- 입력: A, B, C (3개) vs B, C, D, E (4개)
- 교집합: B, C
- 작은 집합: A, B, C
- 작은 집합에서 교집합 제거: A, B, C - B, C = A만 남음
- 결과: A vs B, C, D, E

---

### 규칙 3: 대부분 70% 유사하고 하나만 부분 포함인 경우 집합 전체 제거

**함수**: `_apply_rule3_similar_set_removal()`

**조건**:
- 두 집합의 문장 개수가 동일
- 대부분의 문장이 70% 유사 (완전 일치가 아님)
- 매칭되지 않은 문장이 각각 1개씩
- 그 두 문장 중 하나가 다른 하나에 완전히 포함되고, 길이가 50% 이하

**처리 순서**:
1. **70% 유사도로 일대일 매칭**
   - 각 문장을 70% 유사도로 매칭 (완전 일치도 포함)
   - `calculate_similarity(..., "max")` 또는 완전 일치
2. **매칭되지 않은 문장 찾기**
   - 각각 1개씩만 있어야 함
3. **포함 관계 및 길이 조건 확인**
   - 하나가 다른 하나에 완전히 포함되는지 확인 (`in` 연산자)
   - 포함된 문장의 길이가 포함하는 문장의 50% 이하인지 확인
4. **짧은 문장이 포함된 집합 전체 제거**

**예시**:
- 입력: A, B, C vs A', B, C
- 70% 유사 매칭: B ≈ B (70% 유사), C ≈ C (70% 유사)
- 매칭 안됨: A vs A'
- A'이 A에 완전히 포함되고, A'의 길이가 A의 50% 이하
- 결과: A', B, C 집합 전체 제거

---

## 데이터 구조

### `quote_sentence_cache` 구조
```python
{
    'original': "큰따옴표 발언 문자열",
    'normalized': [정규화된 문장 리스트]
}
```

### `deduplicated_entries` 구조
```python
{
    "큰따옴표 발언": "문장1  문장2  문장3",
    # ... 기타 필드들
}
```

---

## 처리 우선순위 요약

1. **완전 동일한 집합** → 현재 항목 전체 제거
2. **규칙 3** (대부분 70% 유사, 하나만 부분 포함) → 짧은 문장 포함 집합 전체 제거
3. **규칙 2** (교집합 제거) → 작은 집합에서 교집합 제거
4. **규칙 1** (개별 문장 단위) → 짧은 문장 제거
5. **하위 호환성 로직** (포함 관계, 완전 일치)

---

## 주의사항

1. **중첩 루프의 인덱스 관리**
   - 리스트에서 삭제 시 인덱스 조정 필요
   - `comparison_index -= 1` (저장된 항목 제거 시)

2. **문장 분리 기준**
   - `"  "` (공백 2개)로 분리

3. **정규화**
   - 모든 비교는 정규화된 문장으로 수행
   - 원본은 최종 결과에만 사용

4. **유사도 계산 기준**
   - 포함 관계: 작은 쪽 기준 (100%)
   - 일반 유사도: 큰 쪽 기준 (70% 임계값, "max")

